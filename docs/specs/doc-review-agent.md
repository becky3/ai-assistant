# ドキュメントレビューサブエージェント

## 概要

仕様書（`docs/specs/*.md`）の品質を自動レビューするClaude Codeサブエージェント。仕様駆動開発の観点から、構造の完全性、受け入れ条件の品質、情報の過不足、コードとの整合性をチェックし、改善提案を行う。

## 背景

Learning Companionプロジェクトは仕様駆動開発を採用しており、すべての機能実装は `docs/specs/` の仕様書に基づいて行われる。仕様書の品質が低いと、実装時の混乱や手戻りが発生し、開発効率が低下する。

一方で、仕様書の品質レビューは以下の課題がある:
- 構造の網羅性チェックが手作業で煩雑
- 受け入れ条件の具体性が主観的になりがち
- ファイル参照の整合性確認が漏れやすい
- レビュー観点がレビュアーによってばらつく

これらを解消するため、仕様駆動開発の観点で一貫した品質基準を適用できるレビューエージェントを実装する。

## ユーザーストーリー

- 開発者として、仕様書を作成した後に `doc-reviewerサブエージェント` でレビューを受け、品質を向上させたい
- 開発者として、仕様書更新時にレビューエージェントで変更箇所の妥当性を確認したい
- 開発者として、全仕様書をまとめてレビューし、プロジェクト全体のドキュメント品質を把握したい

## 技術仕様

### サブエージェント定義

**ファイル**: `.claude/agents/doc-reviewer.md`

**メタデータ:**
```yaml
name: doc-reviewer
description: 仕様書(docs/specs/*.md)の品質レビュー専門家。仕様駆動開発の観点から不足・過剰な情報を検出し、改善提案を行う。ドキュメント作成・更新後に積極的に使用する。
tools: Read, Grep, Glob, Bash
model: sonnet
permissionMode: default
```

### レビュー観点

#### 1. 構造の完全性

以下のセクションが揃っているかチェック:
- 概要
- 背景（または「ユーザーストーリー」の前に説明）
- ユーザーストーリー
- 技術仕様（入出力仕様、処理フロー）
- 受け入れ条件 (AC)
- 使用LLMプロバイダー（該当する場合）
- 関連ファイル
- テスト方針

#### 2. 受け入れ条件（AC）の品質

- `- [ ]` 形式でチェックボックスとして記載されているか
- 各ACが具体的で検証可能か
- 実装の「何を」検証するかが明確か

#### 3. 情報の過不足

**不足の検出:**
- 技術仕様に入出力の具体例が含まれているか
- 関連ファイルのテーブルに役割が記載されているか
- 使用LLMプロバイダーの選定理由が説明されているか（該当する場合）

**過剰の検出:**
- 具体的な実装詳細（コードスニペット、関数名）が含まれていないか
- 仕様ではなく実装メモになっていないか

#### 4. コードとの整合性

- 関連ファイルに記載されたファイルが実際に存在するか
- サービスクラスのdocstringに仕様書パスが記載されているか（CLAUDE.mdのコーディング規約）

#### 5. テンプレート準拠

- `docs/specs/overview.md` のテンプレート構造に従っているか
- 他の仕様書と一貫性があるか

### 処理フロー

1. **対象の特定**
   - 引数でファイルパスが指定されていればそれをレビュー
   - 未指定なら `docs/specs/` の全仕様書をレビュー

2. **構造チェック**
   - 各セクションの有無を確認
   - 欠落セクションがあれば指摘

3. **内容の詳細レビュー**
   - 各セクションの品質を評価
   - 受け入れ条件の具体性を確認
   - 不足・過剰な情報を検出

4. **実装との整合性確認**
   - 関連ファイルの存在確認
   - サービスクラスのdocstringチェック（該当する場合）

5. **レポート生成**
   - 優先度別に整理（Critical > Warning > Suggestion）
   - 各問題の具体的な改善提案を提供

### 入出力仕様

#### 入力

ユーザーがClaude Codeで以下のように呼び出す:

```
doc-reviewerサブエージェントを使用して docs/specs/f1-chat.md をレビューしてください
```

または:

```
doc-reviewerサブエージェントで全仕様書をレビューしてください
```

#### 出力

以下の形式でレビュー結果を返す:

```markdown
### ファイル: docs/specs/f1-chat.md

#### ✅ 良好な点
- すべての必須セクションが揃っている
- 受け入れ条件が具体的で検証可能
- 入出力仕様に具体例が含まれている

#### ⚠️ 改善が必要な点

**Warning（修正推奨）:**
- [異常系シナリオ]: 「APIエラー発生時」の振る舞いが仕様に明示されていない
  - 改善案: 想定されるエラーコードごとのユーザーへの通知方法とログ出力方針を追記

**Suggestion（改善検討）:**
- [テスト方針]: 具体的なテストケース数やカバレッジ目標があるとより明確
  - 改善案: 「LLM APIモックテスト: 3ケース、会話履歴テスト: 5ケース」など具体化

#### 📊 総評
- 仕様として十分な品質。実装を進める上でのリスクは低い
- サービスクラスへの仕様書パス記載は CLAUDE.md のコーディング規約に従うため推奨
```

## 使用LLMプロバイダー

**Claude Code (Sonnet モデル)** — サブエージェントとして使用

**選定理由:**
- ドキュメントレビューは、構造分析、品質評価、改善提案など、高度な推論力が必要なタスク
- サブエージェント定義のメタデータで `model: sonnet` を指定し、Sonnetモデルで実行
- 仕様駆動開発の観点からの評価には、文脈理解と論理的な分析が重要

## 受け入れ条件

- [ ] AC1: `.claude/agents/doc-reviewer.md` が正しく作成され、Claude Codeから呼び出せる
- [ ] AC2: 単一ファイル指定時に該当ファイルのみレビューする
- [ ] AC3: ファイル未指定時に `docs/specs/` の全仕様書をレビューする
- [ ] AC4: 構造の完全性チェックで欠落セクションを検出できる
- [ ] AC5: 受け入れ条件の品質チェックで曖昧なACを指摘できる
- [ ] AC6: 関連ファイルの存在確認で存在しないファイルを指摘できる
- [ ] AC7: レビュー結果が優先度別（Critical/Warning/Suggestion）に整理される
- [ ] AC8: 各指摘に具体的な改善案が含まれる
- [ ] AC9: `docs/handover/`, `docs/retro/` はレビュー対象外として除外される
- [ ] AC10: テンプレート準拠チェックで一貫性のない構造を指摘できる

## 関連ファイル

| ファイル | 役割 |
|---------|------|
| `.claude/agents/doc-reviewer.md` | サブエージェント定義（レビュー基準とプロンプト） |
| `docs/specs/*.md` | レビュー対象の仕様書 |
| `docs/specs/overview.md` | 仕様書テンプレート定義（参照用） |
| `CLAUDE.md` | コーディング規約（docstringルール等） |

## テスト方針

Claude Codeサブエージェントは実行時テストが中心となるため、以下を手動で確認:

### 基本動作テスト

- [ ] 既存の仕様書（`f1-chat.md`, `f2-feed-collection.md` など）をレビューし、適切な指摘が得られるか
- [ ] 意図的に不完全な仕様書を作成し、欠落セクションが検出されるか
- [ ] 関連ファイルに存在しないファイルパスを記載し、検出されるか

### 誤検出チェック

- [ ] 正しい仕様書に対して誤った指摘（過検出）が出ないか
- [ ] 必須でないセクション（例: LLMプロバイダー）の欠如を誤って Critical として指摘しないか

### レビュー品質

- [ ] 指摘が具体的で実用的な改善案を含むか
- [ ] 優先度（Critical/Warning/Suggestion）の判定が妥当か
- [ ] 総評が仕様駆動開発の観点で有益な情報を含むか

## 拡張性

将来的に以下の機能を追加可能:

- **自動修正モード**: 検出した問題を自動で修正する（`permissionMode: acceptEdits` のバリアント）
- **レポート生成**: 全仕様書のレビュー結果をサマリーレポートとして出力
- **CI/CD統合**: PRに仕様書変更が含まれる場合、自動でレビューを実行
- **カスタムルール**: プロジェクト固有のレビュールールを追加
