name: RAG Evaluation

on:
  schedule:
    - cron: '0 9 * * 1'  # 毎週月曜 9:00 UTC
  workflow_dispatch:
    inputs:
      save_baseline:
        description: 'Save current results as new baseline'
        type: boolean
        default: false
  pull_request:
    paths:
      - 'src/rag/**'
      - 'src/embedding/**'
      - 'src/services/rag_knowledge.py'
      - 'tests/fixtures/rag_evaluation_dataset.json'
      - 'tests/fixtures/rag_test_documents.json'

permissions:
  contents: read
  pull-requests: write

jobs:
  evaluate:
    runs-on: ubuntu-latest
    env:
      RAG_ENABLED: "true"
      EMBEDDING_PROVIDER: "online"
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: pip install -e ".[dev]"

      - name: Setup test ChromaDB
        run: |
          python -m src.rag.cli init-test-db \
            --persist-dir ./test_chroma_db \
            --fixture tests/fixtures/rag_test_documents.json

      - name: Run RAG evaluation
        id: evaluate
        run: |
          python -m src.rag.cli evaluate \
            --output-dir reports/rag-evaluation \
            --baseline-file reports/rag-evaluation/baseline.json \
            ${{ github.event.inputs.save_baseline == 'true' && '--save-baseline' || '' }} \
            ${{ github.event_name == 'pull_request' && '--fail-on-regression' || '' }}

      - name: Upload evaluation report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: rag-evaluation-report
          path: reports/rag-evaluation/

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const reportPath = 'reports/rag-evaluation/report.md';
            if (fs.existsSync(reportPath)) {
              const report = fs.readFileSync(reportPath, 'utf8');
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: report
              });
            }
